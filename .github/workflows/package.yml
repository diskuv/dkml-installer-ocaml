name: Package OCaml Releases

env:
  DEFAULT_DISKUV_OPAM_REPOSITORY_TAG: "v0.4.0-prerel3"
  PIN_OCAMLFIND: "1.9.1"
  PIN_OCAMLBUILD: "0.14.0"
on:
  workflow_dispatch:
    inputs:
      populate-cache:
        description: "Enable if downloads should occur but not builds. Falls back to a full build if not supported by Opam"
        required: false
        type: boolean
      dkml-component-ocamlrun:
        description: "Git branch, tag or commit for ocamlrun component"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      dkml-component-ocamlcompiler:
        description: "Git branch, tag or commit for dkml-component-ocamlcompiler, conf-dkml-cross-toolchain and dkml-option-32bit"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      dkml-install:
        description: "Git branch, tag or commit for dkml-install package"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      dkml-install-runner:
        description: "Git branch, tag or commit for dkml-install-runner package"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      dkml-base-compiler:
        description: "Git branch, tag or commit for dkml-base-compiler package"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      temp-ocaml:
        description: "Git branch, tag or commit for ocaml package temporarily in the dkml-component-ocamlcompiler repository"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      temp-ocaml-config:
        description: "Git branch, tag or commit for ocaml-config package temporarily in the dkml-component-ocamlcompiler repository"
        required: false
        default: "" # Change this to "@repository@" once published to Opam
      diskuv-opam-repository:
        description: "Git branch, tag or commit for ocaml-config package temporarily in the diskuv-opam-repository repository"
        required: false
        default: "" # DEFAULT_DISKUV_OPAM_REPOSITORY_TAG is used as default for empty strings
  push:
    branches:
      - 'main'

jobs:
  package:
    strategy:
      fail-fast: false
      matrix:
        # bootstrap-opam-version
        #   We need an old working Opam; see BOOTSTRAPPING.md.
        #   We use https://github.com/diskuv/dkml-installer-ocaml/releases
        #   to get an old one; you specify its version number here.
        #   Special value of 'os' means use the OS's package manager
        #   (yum/apt/brew).
        # opam-root
        #   We need a stable location for OPAMROOT even if the version of Opam
        #   changes (there are two versions: bootstrap and the compiled one).
        # vsstudio-dir
        #   Only needed if `os: windows-*`. The forward slashes must be double-
        #   slashed because it is passed to Opam setenv as an OCaml string.
        # vsstudio-vcvarsver
        #   Only needed if `os: windows-*`. The VERSION in
        #   `vsdevcmd.bat -vcvars_ver=VERSION`. Example: 14.26. See the output
        #   of the "Audit Visual Studio on Windows" step to see the supported
        #   versions (either xx.yy or xx.yy.zz should work).
        # vsstudio-winsdkver
        #   Only needed if `os: windows-*`. The VERSION in
        #   `vsdevcmd.bat -winsdk=VERSION`. Example: 10.0.18362.0. See the
        #   output of the "Audit Visual Studio on Windows" step to see the
        #   supported versions.
        # dkml-options:
        #   Space separated list of `dkml-option-*` packages.
        #
        #   Use 32-bit installers when possible for maximum portability of
        #   OCaml bytecode. macos is onlt the major platform without 32-bit.
        #   You don't need to include `dkml-option-32bit` because it is auto
        #   chosen when the target ABI ends with x86.
        include:
          #   windows-latest will be windows-2022, which has untested VS2022
          - os: windows-2019
            bootstrap-opam-version: "0.0.0"
            # The 32-bit Opam binary has some problems with
            # `Unix.create_process` giving:
            #   "create_process" failed on sleep: Bad file descriptor
            # So use 64-bit Opam binary
            opam-abi: windows_x86 #_64
            dkml-target-abi: windows_x86
            opam-root: D:/.opam
            vsstudio-dir: C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise
            vsstudio-vcvarsver: "14.25"
            vsstudio-winsdkver: "10.0.18362.0"
          - os: ubuntu-latest
            bootstrap-opam-version: "os"
            dkml-target-abi: linux_x86
            opam-root: /home/runner/.opam
          - os: macos-latest
            bootstrap-opam-version: "os"
            dkml-target-abi: darwin_x86_64
            opam-root: /Users/runner/.opam
    env:
      INSTALLERNAME: ocaml

      SHOULD_POPULATE_CACHE:  ${{ github.event.inputs.populate-cache }}
      # Although the user expressed desire to populate the cache, only
      # Opam 2.1 (?) and greater has the --download-only option. The OS
      # provided opam may not have the option.
      CAN_DOWNLOAD_ONLY:      ${{ matrix.bootstrap-opam-version != 'os' }}

      # When non-empty, instead of building the standard components from the
      # central Opam repository, use the github/gitlab development repositories
      # directly.
      DKML_COMPONENT_OCAMLRUN:      "${{ github.event.inputs.dkml-component-ocamlrun }}"
      DKML_COMPONENT_OCAMLCOMPILER: "${{ github.event.inputs.dkml-component-ocamcompiler }}"
      DKML_INSTALL:                 "${{ github.event.inputs.dkml-install }}"
      DKML_INSTALL_RUNNER:          "${{ github.event.inputs.dkml-install-runner }}"
      DKML_BASE_COMPILER:           "${{ github.event.inputs.dkml-base-compiler }}"
      TEMP_OCAML:                   "${{ github.event.inputs.temp-ocaml }}"
      TEMP_OCAML_CONFIG:            "${{ github.event.inputs.temp-ocaml-config }}"
      DISKUV_OPAM_REPOSITORY:       "${{ github.event.inputs.diskuv-opam-repository }}"
      # These are not independent of dkml-component-ocamlcompiler; they reside in same
      # repository; we cannot go over max 10 GitHub workflow inputs.
      CONF_DKML_CROSS_TOOLCHAIN:    "${{ github.event.inputs.dkml-component-ocamlcompiler }}"
      DKML_OPTION_32BIT:            "${{ github.event.inputs.dkml-component-ocamlcompiler }}"

      # `>-` will flatten the multiple lines into a single line with no trailing EOL.
      # By design `populate-cache` is not part of the cache key
      CACHE_KEY_GITHUB_INPUTS: >-
        DKML_COMPONENT_OCAMLRUN=${{ github.event.inputs.dkml-component-ocamlrun }}
        DKML_COMPONENT_OCAMLCOMPILER=${{ github.event.inputs.dkml-component-ocamcompiler }}
        DKML_INSTALL=${{ github.event.inputs.dkml-install }}
        DKML_INSTALL_RUNNER=${{ github.event.inputs.dkml-install-runner }}
        DKML_BASE_COMPILER=${{ github.event.inputs.dkml-base-compiler }}
        CONF_DKML_CROSS_TOOLCHAIN=${{ github.event.inputs.dkml-component-ocamlcompiler }}
        TEMP_OCAML=${{ github.event.inputs.temp-ocaml }}
        TEMP_OCAML_CONFIG=${{ github.event.inputs.temp-ocaml-config }}
        DKML_OPTION_32BIT=${{ github.event.inputs.dkml-component-ocamlcompiler }}
        DISKUV_OPAM_REPOSITORY=${{ github.event.inputs.diskuv-opam-repository }}

      OPAMROOT: ${{ matrix.opam-root }}
      VS_DIR: ${{ matrix.vsstudio-dir }}
      VS_VCVARSVER: ${{ matrix.vsstudio-vcvarsver }}
      VS_WINSDKVER: ${{ matrix.vsstudio-winsdkver }}
      # Use an M_ prefix so don't interfere with any internal DKML use
      M_DKMLOPTIONS: ${{ matrix.dkml-options }}
      M_DKMLTARGETABI: ${{ matrix.dkml-target-abi }}

      # Increase if you get `make inconsistent assumptions over interface Stdlib__format` errors
      # or if you otherwise need a fresh Opam root
      OPAM_ROOT_CACHE_NUMBER: 6

      # Remove warnings
      HOMEBREW_NO_INSTALL_CLEANUP: 1
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.dkml-target-abi }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Audit Visual Studio on Windows
        if: ${{ startsWith(matrix.os, 'windows-') }}
        shell: pwsh
        run: |
          & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -all -products *
          dir "$env:VS_DIR\VC\Tools\MSVC"
          dir "C:\Program Files (x86)\Windows Kits\10\include"

      # Install utilities
      #   tree: Nice for pretty-printing the final package tree
      #   wget: Needed for the Windows Opam download-command
      #   make: Needed for OCaml ./configure + make
      - name: Install Windows tools
        env:
          TREE_VER: 1.8.0-1
          WGET_VER: 1.21.2-1
          MAKE_VER: 4.3-3
          # libpcre2: Needed for wget
          LIBPCRE2_VER: 8-10.35-1
          # rsync: On Windows the `cp` fallback can fail; loosely related to
          #        https://github.com/ocaml/opam/issues/4080
          RSYNC_VER: 3.2.3-2
          # libzstd: Needed for rsync
          LIBZSTD_VER: 1.5.1-1
          # libxxhash: Needed for rsync
          LIBXXHASH_VER: 0.8.1-1
        if: ${{ startsWith(matrix.os, 'windows-') }}
        shell: bash
        run: |
          untarxz() {
            prefix=$1; shift
            ver=$1; shift
            curl -L -o $prefix$ver-x86_64.pkg.tar.xz http://repo.msys2.org/msys/x86_64/$prefix$ver-x86_64.pkg.tar.xz
            tar xfCJ $prefix$ver-x86_64.pkg.tar.xz /
            rm -f $prefix$ver-x86_64.pkg.tar.xz
          }
          untarzst() {
            prefix=$1; shift
            ver=$1; shift
            curl -L -o $prefix$ver-x86_64.pkg.tar.zst http://repo.msys2.org/msys/x86_64/$prefix$ver-x86_64.pkg.tar.zst
            tar xfC $prefix$ver-x86_64.pkg.tar.zst / --use-compress-program='zstd -d'
            rm -f $prefix$ver-x86_64.pkg.tar.zst
          }
          untarxz tree- "$TREE_VER"
          untarzst wget- "$WGET_VER"
          untarzst libpcre2_ "$LIBPCRE2_VER"
          untarzst make- "$MAKE_VER"
          untarzst rsync- "$RSYNC_VER"
          untarzst libzstd- "$LIBZSTD_VER"
          untarzst libxxhash- "$LIBXXHASH_VER"
      - name: Install Ubuntu tools
        if: ${{ startsWith(matrix.os, 'ubuntu-') }}
        run: sudo env DEBIAN_FRONTEND="noninteractive" apt-get -q install -y --no-install-recommends tree
      - name: Install macOS tools
        if: ${{ startsWith(matrix.os, 'macos-') }}
        run: brew install tree

      # Requirements
      #   - gcc-/g++-multilib for 32bit option (depext from Opam should auto-install in dkml-option-32bit, but we
      #     need to be resilient to Opam version changes)
      #   - link.exe from MSYS2 shadows link.exe from MSVC
      - name: Install 32-bit Ubuntu requirements
        if: ${{ startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.dkml-target-abi, 'x86') }}
        run: sudo env DEBIAN_FRONTEND="noninteractive" apt-get -q install -y --no-install-recommends gcc-multilib g++-multilib
      - name: Uninstall MSYS2 conflicting executables
        if: ${{ startsWith(matrix.os, 'windows-') }}
        shell: bash
        run: rm -vf /usr/bin/link.exe

      # Bootstrap Opam (only necessary for INSTALLER_NAME=ocaml)

      #   Bootstrap from package manager
      - name: Bootstrap Opam from Ubuntu package manager
        if: ${{ startsWith(matrix.os, 'ubuntu-') && matrix.bootstrap-opam-version == 'os' }}
        run: sudo env DEBIAN_FRONTEND="noninteractive" apt-get -q install -y --no-install-recommends opam
      - name: Bootstrap Opam from macOS 'brew' package manager
        if: ${{ startsWith(matrix.os, 'macos-') && matrix.bootstrap-opam-version == 'os' }}
        run: brew install gpatch && brew install opam

      #   Bootstrap from historical release
      - name: Cache Opam bootstrap
        if: ${{ matrix.bootstrap-opam-version != 'os' }}
        uses: actions/cache@v2
        env:
          CACHE_NUMBER: 1
        with:
          path: bootstrap
          key:
            ${{ runner.os }}-bootstrap-${{ env.CACHE_NUMBER }}-${{ matrix.bootstrap-opam-version }}
      - name: Bootstrap Opam from historical release
        if: ${{ matrix.bootstrap-opam-version != 'os' }}
        shell: bash
        env:
          VER: ${{ matrix.bootstrap-opam-version }}
          ABI: ${{ matrix.opam-abi }}
        run: |
          set -x
          install -d bootstrap
          cd bootstrap
          ABI=${ABI:-$M_DKMLTARGETABI} # default to the target abi
          if [ ! -e ocaml-$ABI-$VER.tar.gz ]; then
            curl -L -o ocaml-$ABI-$VER.tmp.tar.gz https://github.com/diskuv/dkml-installer-ocaml/releases/download/v$VER/ocaml-$ABI-$VER.tar.gz
            mv ocaml-$ABI-$VER.tmp.tar.gz ocaml-$ABI-$VER.tar.gz
            rm -f bin/opam bin/opam.exe
          fi
          if [ ! -e bin/opam ] && [ ! -e bin/opam.exe ]; then
            tar xfz ocaml-$ABI-$VER.tar.gz --strip-components=2
          fi

      # Build the installer

      - name: Cache Opam root
        uses: actions/cache@v2
        with:
          path: |
            ${{ matrix.opam-root }}/config
            ${{ matrix.opam-root }}/installer-${{ env.INSTALLERNAME }}
            ${{ matrix.opam-root }}/.ci.root-init
          key:
            ${{ runner.os }}-opamroot-${{ env.OPAM_ROOT_CACHE_NUMBER }}-${{
              matrix.bootstrap-opam-version }}-${{ env.DEFAULT_DISKUV_OPAM_REPOSITORY_TAG }}-${{ env.CACHE_KEY_GITHUB_INPUTS }}

      - name: Initialize Opam root
        env:
          ISWINDOWS: ${{ startsWith(matrix.os, 'windows-') }}
        shell: bash
        # Complicated Opam sequence is because:
        # 1. Opam's default curl does not work on Windows,
        #    and `opam init` does not provide a way to change it (TODO: need
        #    a PR!).
        # 2. We have to separate the Opam download cache from the other Opam
        #    caches
        run: |
          PATH="$PWD/bootstrap/bin:$PATH"
          set "-x"
          if [ ! -e "$OPAMROOT/.ci.root-init" ]; then
            rm -rf "$OPAMROOT" # Clear any partial previous attempt
            if [ "$ISWINDOWS" = true ]; then
              opam init --disable-sandboxing --no-setup --kind local --bare "$(cygpath -am empty-opam-repository)"
              opam option --yes --global download-command=wget
            else
              opam init --disable-sandboxing --no-setup --kind local --bare "$PWD/empty-opam-repository"
            fi
            touch "$OPAMROOT/.ci.root-init"
          fi

      - name: Cache Opam downloads and repositories
        uses: actions/cache@v2
        env:
          CACHE_NUMBER: 1
        with:
          path: |
            ${{ matrix.opam-root }}/repo
            ${{ matrix.opam-root }}/download-cache
            ${{ matrix.opam-root }}/.ci.repo-init
          key:
            ${{ runner.os }}-opamrepo-${{ env.OPAM_ROOT_CACHE_NUMBER }}-${{ env.CACHE_NUMBER }}

      - name: Setup Opam repositories
        shell: bash
        run: |
          PATH="$PWD/bootstrap/bin:$PATH"
          set "-x"
          if [ ! -e "$OPAMROOT/.ci.repo-init" ]; then
            opam repository remove default --yes --all --dont-select || true
            opam repository remove diskuv --yes --all --dont-select || true
            opam repository add default https://opam.ocaml.org --yes --dont-select
            opam repository add diskuv "git+https://github.com/diskuv/diskuv-opam-repository.git#${DISKUV_OPAM_REPOSITORY:-$DEFAULT_DISKUV_OPAM_REPOSITORY_TAG}" --yes --dont-select
            touch "$OPAMROOT/.ci.repo-init"
          fi

      - name: Create installer Opam switch
        shell: bash
        run: '[ -d "$OPAMROOT/installer-$INSTALLERNAME/.opam-switch" ] || PATH="$PWD/bootstrap/bin:$PATH" opam switch create installer-$INSTALLERNAME --repos default,diskuv --empty'

      - name: Pin dkml-component-ocamlrun to source instead of Opam repository
        if: ${{ env.DKML_COMPONENT_OCAMLRUN != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-component-ocamlrun "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${DKML_COMPONENT_OCAMLRUN:-main}"

      - name: Pin dkml-component-ocamlcompiler to source instead of Opam repository
        if: ${{ env.DKML_COMPONENT_OCAMLCOMPILER != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-component-ocamlcompiler "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${DKML_COMPONENT_OCAMLCOMPILER:-main}"

      - name: Pin dkml-install to source instead of Opam repository
        if: ${{ env.DKML_INSTALL != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-install "git://github.com/diskuv/dkml-install-api.git#${DKML_INSTALL:-main}"

      - name: Pin dkml-install-runner to source instead of Opam repository
        if: ${{ env.DKML_INSTALL_RUNNER != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-install-runner "git://github.com/diskuv/dkml-install-api.git#${DKML_INSTALL_RUNNER:-main}"

      - name: Pin dkml-base-compiler to source instead of Opam repository
        if: ${{ env.DKML_BASE_COMPILER != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-base-compiler "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${DKML_BASE_COMPILER:-main}"

      - name: Pin conf-dkml-cross-toolchain to source instead of Opam repository
        if: ${{ env.CONF_DKML_CROSS_TOOLCHAIN != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action conf-dkml-cross-toolchain "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${CONF_DKML_CROSS_TOOLCHAIN:-main}"

      - name: (Temporary) Pin ocaml.4.12.1 to source instead of Opam repository
        if: ${{ env.TEMP_OCAML != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action ocaml.4.12.1 "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${TEMP_OCAML:-main}"

      - name: (Temporary) Pin ocaml-config.2 to source instead of Opam repository
        if: ${{ env.TEMP_OCAML_CONFIG != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action ocaml-config.2 "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${TEMP_OCAML_CONFIG:-main}"

      - name: Pin dkml-option-32bit to source instead of Opam repository
        if: ${{ env.DKML_OPTION_32BIT != '@repository@' }}
        shell: bash
        run: PATH="$PWD/bootstrap/bin:$PATH" opam pin add --yes --no-action dkml-option-32bit "git://github.com/diskuv/dkml-component-ocamlcompiler.git#${DKML_OPTION_32BIT:-main}"

      # ocamlfind and ocamlbuild have patches necessary for Windows in diskuv-opam-repository
      - name: Pin ocamlfind ${{ env.PIN_OCAMLFIND }}, ocamlbuild ${{ env.PIN_OCAMLBUILD }}
        shell: bash
        run: |
          PATH="$PWD/bootstrap/bin:$PATH"
          opam pin add --yes --no-action -k version ocamlfind ${{ env.PIN_OCAMLFIND }}
          opam pin add --yes --no-action -k version ocamlbuild ${{ env.PIN_OCAMLBUILD }}

      - name: Use Visual Studio in DKML Opam packages
        if: ${{ startsWith(matrix.os, 'windows-') }}
        shell: bash
        # nit: Perhaps more of these VS_ values should come from `matrix`.
        run: |
          PATH="$PWD/bootstrap/bin:$PATH"
          opam option setenv= # reset
          opam option setenv+='DKML_COMPILE_SPEC = "1"'
          opam option setenv+='DKML_COMPILE_TYPE = "VS"'
          opam option setenv+="DKML_COMPILE_VS_DIR = \"$VS_DIR\""
          opam option setenv+="DKML_COMPILE_VS_VCVARSVER = \"$VS_VCVARSVER\""
          opam option setenv+="DKML_COMPILE_VS_WINSDKVER = \"$VS_WINSDKVER\""
          opam option setenv+='DKML_COMPILE_VS_MSVSPREFERENCE = "VS16.6"'
          opam option setenv+='DKML_COMPILE_VS_CMAKEGENERATOR = "Visual Studio 16 2019"'
          opam option setenv+="DKML_HOST_ABI = \"$M_DKMLTARGETABI\""
          opam option setenv # print

      - name: Build installer for Windows
        if: ${{ startsWith(matrix.os, 'windows-') }}
        shell: cmd
        timeout-minutes: 60
        env:
          VSCMD_SKIP_SENDTELEMETRY: 1
          # Use env vars to communicate to crossplatform-functions.sh and
          # anybody else with a Unix detection probe
          # that a Unix environment is available (MSYS2 from Git Bash)
          MSYSTEM: MINGW64
          MSYSTEM_CARCH: x86_64
          MSYSTEM_CHOST: x86_64-w64-mingw32
          MSYSTEM_PREFIX: /mingw64
        run: |
          REM OCaml (dkml-base-compiler) will compile fine but any other
          REM packages (ocamlbuild, etc.) which
          REM need a native compiler will fail without the MSVC compiler in the
          REM PATH. There isn't a `with-dkml.exe` alternative available at
          REM this stage of the GitHub workflow.
          call "%VS_DIR%\Common7\Tools\VsDevCmd.bat" -no_logo -vcvars_ver=%VS_VCVARSVER% -winsdk=%VS_WINSDKVER%
          if %ERRORLEVEL% neq 0 (
            echo.
            echo.The "%VS_DIR%\Common7\Tools\VsDevCmd.bat" command failed
            echo.with exit code %ERRORLEVEL%.
            echo.
            exit /b %ERRORLEVEL%
          )

          REM We must place MSYS2 (Git Bash) in front of path so that MSYS2
          REM tar.exe is used instead of Windows tar.exe.
          set PATH=%CD%\bootstrap\bin;C:\Program Files\Git\usr\bin;%PATH%

          if "%SHOULD_POPULATE_CACHE%" == "true" (
            if "%CAN_DOWNLOAD_ONLY%" == "true" (
              set MOREARGS=--download-only
              set ENVARGS=OPAMDOWNLOADJOBS=1
            )
          )
          if "%M_DKMLTARGETABI:~-4%" == "_x86" (
            set M_DKMLOPTION_32BIT=dkml-option-32bit
          )
          env %ENVARGS% opam install --yes --switch installer-%INSTALLERNAME% %M_DKMLOPTIONS% %M_DKMLOPTION_32BIT% ./dkml-installer-%INSTALLERNAME%.opam %MOREARGS% --verbose --debug-level 2

      - name: Build installer for non-Windows
        if: ${{ !startsWith(matrix.os, 'windows-') }}
        shell: bash
        timeout-minutes: 60
        run: |
          PATH="$PWD/bootstrap/bin:$PATH"
          case "$M_DKMLTARGETABI" in
            *_x86) M_DKMLOPTION_32BIT=dkml-option-32bit ;;
            *)     M_DKMLOPTION_32BIT= ;;
          esac
          if [ "$SHOULD_POPULATE_CACHE" = true ] && [ "$CAN_DOWNLOAD_ONLY" = true ]; then
            env OPAMDOWNLOADJOBS=1 opam install --yes --switch installer-$INSTALLERNAME $M_DKMLOPTIONS $M_DKMLOPTION_32BIT ./dkml-installer-$INSTALLERNAME.opam --download-only
          else
            opam install --yes --switch installer-$INSTALLERNAME $M_DKMLOPTIONS $M_DKMLOPTION_32BIT ./dkml-installer-$INSTALLERNAME.opam
          fi

      # Examine the Opam package
      - name: Examine the installer
        shell: bash
        run: S=$(PATH="$PWD/bootstrap/bin:$PATH" opam var share) ; if [ -e "$S" ]; then if [ -x /usr/bin/tree ]; then tree -F -I src "$S"; else find "$S" -name src -prune -o -type f -print; fi; fi
